<div class="container-fluid" style="margin-top: 30px;">
<h1 align="center"> My To-do Tasks </h1>
</div>
<div class="row">
<div class="col-md-3">
<button type="button" class="btn btn-secondary">
<%= link_to "view completed tasks", view_completed_path(@user), method: :get, style:"color:white" %>
</button>
</div>

<!-- SEARCH FUNCTION -->
<div class="col-md-9" style="text-align: right;">
<%= form_tag(search_task_path, method: "get") do %>
  <h3 style="display: inline;">search by tag   </h3>
  <%= select_tag(:tag, options_for_select([nil, 'Work', 'Study', 'Family', 'Shopping', 'Entertainment', 'Miscellaneous'])) %>
  <%= submit_tag("Search") %>
</div>

</div>
<% end %>

<hr>
<!-- OPTION ONE -->
<div class="row">
	<div class="col-md-8">
<% if @user.tasks.where("due_date < ?", Date.today).any? %>
	<h2>OVERDUE</h2>
	<table class="table table-danger">
		<tr>
			<th>Task</th>
			<th>Due</th>
			<th>Tag</th>
			<th>Priority</th>
			<th>Overdue</th>
			<th colspan="3"></th>
		</tr>

		<% @user.tasks.order("due_date ASC").where("due_date < ?", Date.today).each do |task| %>
			<% if task.is_completed == false %>
			<tr>
				<td><%= task.content %></td>
				<td><%= task.due_date %></td>
				<td><%= task.tag %></td>
				<td><%= task.priority_level %></td>
				<td><%= pluralize(((task.due_date - Date.today) * -1).to_i, "day") %></td>
				<td><%= link_to '', edit_user_task_path(task.user, task), :class => "far fa-edit"%></td>
				<td><%= link_to '', [task.user, task],
	               method: :delete,
	               data: { confirm: 'Are you sure you want to delete this task?' }, :class => "far fa-trash-alt" %></td>
	            <td><%= link_to '', complete_task_path(task.user, task), method: :put, :class => "far fa-check-circle"%></td>
			</tr>
			<% end %>
		<% end %>
	</table>
<% end %>
<% if @user.tasks.where(is_completed: false).where("due_date >= '#{Date.today}' OR due_date IS NULL").any? %>
	<h2>NEED TO DO</h2>
	<table class="table table-info">
		<tr>
			<th>Task</th>
			<th>Due</th>
			<th>Tag</th>
			<th>Priority</th>
			<th>Countdown</th>
			<th colspan="3"></th>
		</tr>

		<% @user.tasks.order("due_date IS NULL, due_date ASC").where("due_date >= '#{Date.today}' OR due_date IS NULL").each do |task| %>
			<% if task.is_completed == false %>
			<tr>
				<td><%= task.content %></td>
				<% if task.due_date.nil? %>
					<td>No Date</td>
				<% else %>
					<td><%= task.due_date %></td>
				<% end %>
				<td><%= task.tag %></td>
				<td><%= task.priority_level %></td>
				<% if not task.due_date.nil? %>
				<% countdown = (task.due_date - Date.today).to_i %>
				<td><% if countdown == 0%>
					<%= "TODAY"%>
					<% elsif countdown == 1
						%>
					<%= "TOMORROW" %>
					<% else %>
					<%= countdown.to_s + " days" %>
					<% end %>
				</td>
				<% else %>
				<td>-</td>
				<% end %>
				<!-- link to edit -->
				<td><%= link_to '', edit_user_task_path(task.user, task), :class => "far fa-edit"%>
				</td>
				<!-- link to delete -->
				<td><%= link_to '', [task.user, task],
	               method: :delete,
	               data: { confirm: 'Are you sure you want to delete this task?' }, :class => "far fa-trash-alt" %></td>
	            <!-- link to mark as complete -->
	            <td><%= link_to '', complete_task_path(task.user, task), method: :put, :class => "far fa-check-circle" %></td>
			</tr>
			<% end %>
		<% end %>
	</table>
<% end %>
<% unless @user.tasks.where(is_completed: false).any? %>
	<h2>You have no to-do task. Create a new task now!</h2>
<% end %>
	</div>
	<div class="col-md-4">
<div class="container bg-warning" style="padding: 10px; top: 45px; position: relative;">
<h1> Add a New Task! </h1>
<% task = @user.tasks.build %>
<!-- flash or flash.now ??? -->
<%= flash.now[:error] %>
<%= form_with(model: [ @user, task ], local: true) do |form| %>
  <!-- <%= task.errors.size %> -->
  <% if task.errors.any? %>
   <h1> aaaaaaaa </h1>
    <div id="error_explanation">
      <h2>
        <%= pluralize(task.errors.count, "error") %> prohibited
        this task from being saved:
      </h2>
      <ul>
        <% task.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <p>
    <%= form.label :content %><br>
    <%= form.text_field :content, placeholder: 'Create a new task here ...'%>
  </p>
 
  <p>
    <%= form.label :due_date %><br>
    <%= form.date_field :due_date, min: Date.today %>
  </p>

  <p>
    <%= form.label :tag %><br>
    <%= form.select(:tag, [nil, 'Work', 'Study', 'Family', 'Shopping', 'Entertainment', 'Miscellaneous']) %>
  </p>

  <p>
    <%= form.label :priority_level %><br>
    <%= form.select(:priority_level, ['★', '★★', '★★★']) %>
  </p>

  <p>
    <%= form.submit %>
  </p>
</div>

<% end %>
</div>
</div>
